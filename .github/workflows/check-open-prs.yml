name: Check Open PRs and Notify Slack
on:
  schedule:
    # ë§¤ 1ì‹œê°„ë§ˆë‹¤ ì‹¤í–‰
    - cron: '0 * * * *'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ì„ ìœ„í•œ íŠ¸ë¦¬ê±°
    inputs:
      force_notify:
        description: "Force Slack notification"
        type: boolean
        default: false

jobs:
  notify_open_prs:
    runs-on: ubuntu-latest
    steps:
    # 1. GitHub ë¦¬í¬ì§€í† ë¦¬ ì²´í¬ì•„ì›ƒ
    - name: Checkout repository
      uses: actions/checkout@v3

    # 2. PR ë°ì´í„° ìˆ˜ì§‘
    - name: Fetch Open PRs with Reviewers
      id: fetch_prs
      run: |
        # ëª¨ë“  ì—´ë¦° PR ê°€ì ¸ì˜¤ê¸°
        prs=$(gh pr list --json number,title,url,reviewRequests --jq '.[] | select(.reviewRequests | length > 0)')
        
        # PR ë°ì´í„° ì¶œë ¥ (ë””ë²„ê¹…ìš©)
        echo "Found PRs: $prs"
        # GITHUB_OUTPUTì— PR ë°ì´í„°ë¥¼ ì €ì¥
        echo "prs=$prs" >> $GITHUB_OUTPUT
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # 3. Slack ì•Œë¦¼ ì „ì†¡
    - name: Notify Slack
      if: steps.fetch_prs.outputs.prs != '' # ì—´ë¦° PRì´ ìˆì„ ë•Œë§Œ ì‹¤í–‰
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      run: |
        echo "Preparing Slack notification..."
        
        # JSON ë°ì´í„°ë¥¼ ë³€ìˆ˜ì— ì €ì¥
        prs_json='${{ steps.fetch_prs.outputs.prs }}'
        
        # PR ë°ì´í„°ê°€ ë¹„ì–´ ìˆëŠ”ì§€ í™•ì¸
        if [ -z "$prs_json" ]; then
          echo "No PRs to notify about."
          exit 0
        fi
        
        # Slack ë©”ì‹œì§€ ì‘ì„±
        message=":rotating_light: *Reviewê°€ í•„ìš”í•œ Pull Requests ëª©ë¡*\n\n"
        
        # PR ë°ì´í„° íŒŒì‹± ë° ë©”ì‹œì§€ ì‘ì„±
        echo "$prs_json" | jq -r '.[] | "ğŸ”¹ *<\(.url)|\(.title)>*\n" + 
          "   â€¢ ë¦¬ë·°ì–´: \(.reviewRequests | map(.login) | join(", "))\n\n"' | while read -r line; do
          message+="$line"
        done
        
        # Slack ë©”ì‹œì§€ í‘¸í„° ì¶”ê°€
        message+=$'\n\n'" :point_right: ë¦¬ë·°ë¥¼ ë¶€íƒë“œë¦½ë‹ˆë‹¤!"
        
        # Slack ë©”ì‹œì§€ í™•ì¸ (ë””ë²„ê¹…)
        echo "Message to Slack: $message"
        
        # Slack ë©”ì‹œì§€ ì „ì†¡
        curl -X POST \
          -H 'Content-type: application/json' \
          --data "{\"text\":\"$message\", \"mrkdwn\": true}" \
          "$SLACK_WEBHOOK_URL"
