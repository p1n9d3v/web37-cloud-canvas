name: Check Open PRs and Notify Slack
on:
  schedule:
    - cron: '0 * * * *'  # ë§¤ 1ì‹œê°„ë§ˆë‹¤ ì‹¤í–‰
  workflow_dispatch:     # ìˆ˜ë™ ì‹¤í–‰ì„ ìœ„í•œ íŠ¸ë¦¬ê±°
    inputs:
      force_notify:
        description: "Force Slack notification"
        type: boolean
        default: false

jobs:
  notify_open_prs:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Fetch Open PRs with Reviewers
      id: fetch_prs
      run: |
        # ë” ìì„¸í•œ PR ì •ë³´ë¥¼ í¬í•¨í•˜ì—¬ ê°€ì ¸ì˜¤ê¸°
        prs=$(gh pr list --json number,title,url,reviewRequests,author,createdAt,body,additions,deletions,changedFiles --jq '.[] | select(.reviewRequests | length > 0)')
        echo "prs=$prs" >> $GITHUB_OUTPUT
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Notify Slack
      if: steps.fetch_prs.outputs.prs != ''
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      run: |
        echo "Preparing Slack notification..."
        prs_json='${{ steps.fetch_prs.outputs.prs }}'
        
        if [ -z "$prs_json" ]; then
          echo "No PRs to notify about."
          exit 0
        fi
        
        # Slack ë©”ì‹œì§€ í—¤ë”
        message=":rotating_light: *Reviewê°€ í•„ìš”í•œ Pull Requests ëª©ë¡*\n\n"
        
        # ê° PRì— ëŒ€í•œ ìƒì„¸ ì •ë³´ ì¶”ê°€
        echo $prs_json | jq -r '.[] | "ğŸ”¹ *<\(.url)|\(.title)>*\n" + 
          "   â€¢ ì‘ì„±ì: \(.author.login)\n" +
          "   â€¢ ìƒì„±ì¼: \(.createdAt | fromdate | strftime("%Y-%m-%d %H:%M"))\n" +
          "   â€¢ ë³€ê²½ì‚¬í•­: +\(.additions) -\(.deletions) (\(.changedFiles)ê°œ íŒŒì¼)\n" +
          "   â€¢ ë¦¬ë·°ì–´: \(.reviewRequests | map(.login) | join(", "))\n" +
          if .body then "   â€¢ ì„¤ëª…: \(.body | split("\n")[0] | if length > 100 then (.[0:100] + "...") else . end)\n" else "" end +
          "\n"' | while read -r line; do
          message+="$line"
        done
        
        # ë©”ì‹œì§€ í‘¸í„° ì¶”ê°€
        message+="\n:point_right: ë¦¬ë·°ë¥¼ ë¶€íƒë“œë¦½ë‹ˆë‹¤!"
        
        # Slack ë©”ì‹œì§€ ì „ì†¡
        curl -X POST \
          -H 'Content-type: application/json' \
          --data "{\"text\":\"$message\", \"mrkdwn\": true}" \
          $SLACK_WEBHOOK_URL
